#############################################################################
## NMAKE [debug=N] [W95=1]
#############################################################################
# TARGETS:
#       ALL
#       ISX     - INSTALLATION DISK USING InstallShield Express
#       INSTALL -
#

!ifdef  DEBUG
DBUG    = -DDBG=$(DEBUG) -DDEBUG
CFLAGS  = -Zi -Od $(DBUG)
LFLAGS  = /CO
!else
DBUG    = -DDBG=0
CFLAGS  = -Ox -Gs $(DBUG)
LFLAGS  =
!endif

!ifdef  W95
PRFX    = 95
INC     = C:\INC32
AFLAGS  = -coff -DBLD_COFF -W2 -c -Cx -Zm -DMASM6 -D_W95_
ASM32   = ML $(AFLAGS) $(DBUG) -DIS_32 -I$(INC) -Fo$*.$(OBJ) $*.ASM
LNK32   = C:\TOOLS32\LINK.EXE
MAPSYM  = C:\TOOLS32\MAPSYM -s -o SPW95.SYM SPW95.MAP
!else
PRFX    = 31
INC     = C:\INC
ASM32   = MASM5 -w2 -Mx $(DBUG) -I$(INC) $*.ASM,$*.$(OBJ);
LNK32   = LINK386.EXE
ADDHDR  = ADDHDR
MAPSYM  = MAPSYM32
!endif

CC32    = C:\TOOLS32\CL $(CFLAGS) -W3 -GX -IC:\INC32 -DWIN32 -D_CONSOLE
CLIB32  = KERNEL32.LIB USER32.LIB GDI32.LIB WINSPOOL.LIB COMDLG32.LIB\
          ADVAPI32.LIB SHELL32.LIB OLE32.LIB OLEAUT32.LIB UUID.LIB

## InstallShield tools
ISHIELD = C:\TOOLS32\ISHIELD
##ISHIELD = C:\Progra~1\Instal~1\Instal~2\PROGRAM

#############################################################################
## Tools for building 16-bit components.
#############################################################################
VC16    =D:\MSVC
L16P    =$(VC16)\LIB
CC16    =$(VC16)\BIN\CL -c -AS $(CFLAGS) -I$(VC16)\INCLUDE -DDOSAPP
ASM16   =C:\TOOLS\MASM51 $(DBUG) -D_W$(PRFX)_
LNK16   =$(VC16)\BIN\LINK $(LFLAGS)
CLIB16  =$(L16P)\SLIBCE.LIB $(L16P)\OLDNAMES.LIB

CCW16   =$(VC16)\BIN\CL -c -Zp1 -G2 -W3 -AM -Gs $(CFLAGS) -I$(VC16)\INCLUDE
CCDLL16 =$(VC16)\BIN\CL -c -Zp1 -G2 -W3 -AM -GD -Gs $(CFLAGS) -D_WINDLL -I$(VC16)\INCLUDE
LNKW16  =$(VC16)\BIN\LINK /NOD /ALIGN:16 $(LFLAGS)
LKDLL16 =$(VC16)\BIN\LINK /NOD /ALIGN:16 $(LFLAGS)
IMPLIB16=$(VC16)\BIN\IMPLIB /nowep
RC16    =$(VC16)\BIN\RC
W16LIBS =$(L16P)\OLDNAMES $(L16P)\LIBW $(L16P)\MLIBCEW $(L16P)\COMMDLG
##W16LIBS =oldnames libw commdlg shell olecli olesvr mdllcew toolhelp

!ifdef  DEBUG
OBJ     = D$(PRFX)
NAME    = SPW$(PRFX)D
!else
OBJ     = O$(PRFX)
NAME    = SPW$(PRFX)
!endif

OBJS    = SP_FLTS.$(OBJ) SP_ASMB.$(OBJ) SP_SYMB.$(OBJ) SP_MAIN.$(OBJ) \
          SP_UTIL.$(OBJ) SP_DISP.$(OBJ) SP_KEYB.$(OBJ) SP_MDOS.$(OBJ) \
          SP_HELP.$(OBJ) SP_KRNL.$(OBJ) SP_PE32.$(OBJ) SP_SVGA.$(OBJ) \
          SP_SERI.$(OBJ) SP_PARA.$(OBJ) SP_MONO.$(OBJ) SP_BRKS.$(OBJ) \
          SP_DBUG.$(OBJ) SP_INIT.$(OBJ)

all:    $(NAME).EXE REMOTE.EXE SPWCC.EXE SPCC.EXE

SPWCC.EXE : SPWCC.OBJ SPLOG.OW1 SPAPI.OBJ SPXPT.OBJ SPWCC.DEF SPWCC.RES
        $(LNKW16) @<<
/ST:6000 /NOD /ALIGN:16 SPWCC SPLOG.OW1 SPAPI SPXPT
SPWCC.EXE
SPWCC.MAP
$(W16LIBS)
SPWCC.DEF;
<<
        $(RC16) /t $*.RES $@

SPWCC.DEF : MAKEFILE
        ECHO >NUL <<$@
NAME        SPWCC
EXETYPE     WINDOWS
PROTMODE

DESCRIPTION 'SoftProbe'
STUB        'WINSTUB.EXE'

CODE        PRELOAD MOVEABLE DISCARDABLE
DATA        PRELOAD MOVEABLE MULTIPLE

HEAPSIZE    16384
EXPORTS
            SprobeAboutProc    @1
            SprobeLogProc      @2
<<KEEP

SPWCC.OBJ: SPWCC.C SPWCC.H SPAPI.INC
        $(CCW16) SPWCC.C

SPWCC.RES: SPWCC.RC SPWCC.H SPWCC.ICO
        $(RC16) /r SPWCC.RC

SPLOG.OW1: SPLOG.C SPAPI.INC
        $(CCDLL16) -Fo$@ SPLOG.C

SPAPI.OBJ: SPAPI.ASM SPAPI.INC SP_KRNL.INC
        $(ASM16) -Mx SPAPI;

SPXPT.OBJ: SPXPT.ASM SPXPO.ASM SPAPI.INC SP_KRNL.INC
        $(ASM16) -Mx SPXPT;

SPLOG.OBJ: SPLOG.C SPAPI.INC
        $(CC16) SPLOG.C

SPCC.OBJ: SPCC.C SPAPI.INC
        $(CC16) SPCC.C

SPCC.EXE: SPCC.OBJ SPLOG.OBJ SPAPI.OBJ SPXPT.OBJ
        $(LNK16) SPCC.OBJ SPLOG.OBJ SPAPI.OBJ SPXPT.OBJ,SPCC.EXE,,$(CLIB16);

REMOTE.EXE: REMOTE.ASM SP_COMM.INC SP_DEFS.INC
        $(ASM16) REMOTE;
        $(LNK16) REMOTE;

$(NAME).STB: SPWIN.ASM SPSYM.ASM SPXPO.ASM SP_COMM.INC SP_DEFS.INC SPAPI.INC
        $(ASM16) SPWIN.ASM,$(NAME).$(OBJ);
        $(LNK16) /KNOWEAS $(NAME).$(OBJ),$(NAME).STB;

SP_FLTS.$(OBJ): SP_FLTS.ASM SP_DEFS.INC SPAPI.INC
        $(ASM32)

SP_INIT.$(OBJ): SP_INIT.ASM SP_DEFS.INC SPAPI.INC
        $(ASM32)

SP_KRNL.$(OBJ): SP_KRNL.ASM SP_DEFS.INC SP_KRNL.INC
        $(ASM32)

SP_PE32.$(OBJ): SP_PE32.ASM SP_DEFS.INC SP_KRNL.INC SPAPI.INC
        $(ASM32)

SP_HELP.$(OBJ): SP_HELP.ASM SP_DEFS.INC
        $(ASM32)

SP_DISP.$(OBJ): SP_DISP.ASM SP_DEFS.INC SP_SCRN.INC
        $(ASM32)

SP_KEYB.$(OBJ): SP_KEYB.ASM SP_DEFS.INC
        $(ASM32)

SP_MONO.$(OBJ): SP_MONO.ASM SP_DEFS.INC SP_SCRN.INC
        $(ASM32)

SP_SVGA.$(OBJ): SP_SVGA.ASM SP_DEFS.INC SP_SCRN.INC
        $(ASM32)

SP_PARA.$(OBJ): SP_PARA.ASM SP_COMM.INC SP_SCRN.INC SP_DEFS.INC
        $(ASM32)

SP_SERI.$(OBJ): SP_SERI.ASM SP_COMM.INC SP_SCRN.INC SP_DEFS.INC
        $(ASM32)

SP_ASMB.$(OBJ): SP_ASMB.ASM SP_DEFS.INC
        $(ASM32)

SP_BRKS.$(OBJ): SP_BRKS.ASM SP_DEFS.INC
        $(ASM32)

SP_DBUG.$(OBJ): SP_DBUG.ASM SP_DEFS.INC
        $(ASM32)

SP_UTIL.$(OBJ): SP_UTIL.ASM SP_DEFS.INC
        $(ASM32)

SP_SYMB.$(OBJ): SP_SYMB.ASM SP_DEFS.INC VXDSYMB.W$(PRFX) SPAPI.INC
        $(ASM32)

SP_MDOS.$(OBJ): SP_MDOS.ASM SP_DEFS.INC
        $(ASM32)

SP_MAIN.$(OBJ): SP_MAIN.ASM SP_DEFS.INC
        $(ASM32)

$(NAME).DEF : MAKEFILE
        ECHO >NUL @<<$(NAME).DEF
!ifdef  W95
VXD     $(NAME).EXE
DESCRIPTION 'SoftProbe/Win95 Release 1.00'
!else
LIBRARY  $(NAME)
DESCRIPTION 'SoftProbe/Win3.1 Release 1.00'
EXETYPE  DEV386
!endif

STUB     '$(NAME).STB'

SEGMENTS
        _LTEXT    PRELOAD NONDISCARDABLE
        _LDATA    PRELOAD NONDISCARDABLE
        _SAFECODE PRELOAD NONDISCARDABLE
        _ITEXT CLASS 'ICODE' DISCARDABLE
        _IDATA CLASS 'ICODE' DISCARDABLE
!ifndef W95
        _TEXT  CLASS 'PCODE' NONDISCARDABLE
        _DATA  CLASS 'PCODE' NONDISCARDABLE
!endif

EXPORTS
!ifdef  DEBUG
        SPWDBG_DDB @1
!else
        SPWIN_DDB  @1
!endif
<<KEEP

SPW31.EXE SPW31D.EXE: $(OBJS) $(NAME).STB $(NAME).DEF
        $(LNK32) @<<
$(LFLAGS) /NOI /NOD /NOP $(OBJS)
$(NAME).EXE,
$(NAME).MAP /MAP,,
$(NAME).DEF
<<
        $(ADDHDR) $(NAME).EXE
        $(MAPSYM) $(NAME)

SPW95.EXE SPW95D.EXE: $(OBJS) $(NAME).STB $(NAME).DEF
        $(LNK32) @<<
/VXD /NOD
/MACHINE:I386 /OUT:$@
$(OBJS)
/MAP:$(NAME).MAP
/DEF:$(NAME).DEF
<<
#       $(MAPSYM) -s -o $(NAME).SYM $(NAME).MAP

#############################################################################
## Include default VxD symbols
#############################################################################
VXDSYMB.W31: MAKESYM.C
        $(CC16) MAKESYM.C
        $(LNK16) MAKESYM.OBJ,MAKESYM.EXE,,$(CLIB16);
        DEL VXDSYMB.W31
        DEL VXDSYMB.TMP
        MAKESYM $(INC)\VMM.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VPICD.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VDMAD.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VTD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\V86MMGR.INC  VXDSYMB.TMP
        MAKESYM $(INC)\PAGESWAP.INC VXDSYMB.TMP
        MAKESYM $(INC)\VDD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VSD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VMD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VKD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VCD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\BLOCKDEV.INC VXDSYMB.TMP
        MAKESYM $(INC)\EBIOS.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VNETBIOS.INC VXDSYMB.TMP
        MAKESYM $(INC)\DOSMGR.INC   VXDSYMB.TMP
        MAKESYM $(INC)\SHELL.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VMPOLL.INC   VXDSYMB.TMP
        MAKESYM $(INC)\DOSNET.INC   VXDSYMB.TMP
        MAKESYM $(INC)\VDD2.INC     VXDSYMB.TMP
        MAKESYM $(INC)\INT13.INC    VXDSYMB.TMP
        MAKESYM $(INC)\PAGEFILE.INC VXDSYMB.TMP
        REN VXDSYMB.TMP VXDSYMB.W31

VXDSYMB.W95: MAKESYM.C
        $(CC16) MAKESYM.C
        $(LNK16) MAKESYM.OBJ,MAKESYM.EXE,,$(CLIB16);
        DEL VXDSYMB.W95
        DEL VXDSYMB.TMP
        MAKESYM $(INC)\VMM.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VKD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\SHELL.INC    VXDSYMB.TMP
        MAKESYM $(INC)\DOSMGR.INC   VXDSYMB.TMP
        MAKESYM $(INC)\VTD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\MINIVDD.INC  VXDSYMB.TMP
        MAKESYM $(INC)\VDD2.INC     VXDSYMB.TMP
        MAKESYM $(INC)\VMD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\IFSMGR.INC   VXDSYMB.TMP
        MAKESYM $(INC)\VXDLDR.INC   VXDSYMB.TMP
        MAKESYM $(INC)\CONFIGMG.INC VXDSYMB.TMP
        MAKESYM $(INC)\DOSNET.INC   VXDSYMB.TMP
        MAKESYM $(INC)\EBIOS.INC    VXDSYMB.TMP
        MAKESYM $(INC)\ENABLE.INC   VXDSYMB.TMP
        MAKESYM $(INC)\INT13.INC    VXDSYMB.TMP
        MAKESYM $(INC)\IOS.INC      VXDSYMB.TMP
        MAKESYM $(INC)\MMDEVLDR.INC VXDSYMB.TMP
        MAKESYM $(INC)\PAGEFILE.INC VXDSYMB.TMP
        MAKESYM $(INC)\PAGESWAP.INC VXDSYMB.TMP
        MAKESYM $(INC)\PCCARD.INC   VXDSYMB.TMP
        MAKESYM $(INC)\V86MMGR.INC  VXDSYMB.TMP
        MAKESYM $(INC)\VCACHE.INC   VXDSYMB.TMP
        MAKESYM $(INC)\VCD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VCOMM.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VCOND.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VDMAD.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VFBACKUP.INC VXDSYMB.TMP
        MAKESYM $(INC)\VFD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VMCPD.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VMPOLL.INC   VXDSYMB.TMP
        MAKESYM $(INC)\VNETBIOS.INC VXDSYMB.TMP
        MAKESYM $(INC)\VPICD.INC    VXDSYMB.TMP
        MAKESYM $(INC)\VPOWERD.INC  VXDSYMB.TMP
        MAKESYM $(INC)\VRDSVC.INC   VXDSYMB.TMP
        MAKESYM $(INC)\VSD.INC      VXDSYMB.TMP
        MAKESYM $(INC)\VWIN32.INC   VXDSYMB.TMP
#       MAKESYM $(INC)\COMM_DRV.INC VXDSYMB.TMP
        REN VXDSYMB.TMP VXDSYMB.W95

#############################################################################
## Building Installation Diskettes...
#############################################################################
INSTALL : SETUP $(NAME).001\$(NAME).Z PKGFILES

SETUP : \
    $(NAME).001\DISK1.ID \
    $(NAME).001\SETUP.EXE \
    $(NAME).001\_SETUP.DLL \
    $(NAME).001\_SETUP.LIB \
    $(NAME).001\_INST32I.EX_ \
    $(NAME).001\_ISDEL.EXE \
    $(NAME).001\UNINST.EXE

PKGFILES : $(NAME).001\SETUP.PKG $(NAME).001\SETUP.INS $(NAME).001\README.1ST

$(NAME).001\DISK1.ID : MAKEFILE
    @IF NOT EXIST $@ MKDIR $(NAME).001
    @IF NOT EXIST $@ MKDIR $(NAME).R
    ECHO DISK1>$@

$(NAME).001\SETUP.EXE : $(ISHIELD)\SETUP.EXE
    COPY $(ISHIELD)\SETUP.EXE $@

$(NAME).001\_SETUP.DLL : $(ISHIELD)\_SETUP.DLL
    COPY $(ISHIELD)\_SETUP.DLL $@

$(NAME).001\_SETUP.LIB : $(ISHIELD)\_SETUP.LIB LICENSE.TXT
    COPY $(ISHIELD)\_SETUP.LIB $@
    $(ISHIELD)\ICOMP.EXE LICENSE.TXT $@

$(NAME).001\_INST32I.EX_ : $(ISHIELD)\_INST32I.EX_
    COPY $(ISHIELD)\_INST32I.EX_ $@

$(NAME).001\_ISDEL.EXE : $(ISHIELD)\_ISDEL.EXE
    COPY $(ISHIELD)\_ISDEL.EXE $@

$(NAME).001\UNINST.EXE : $(ISHIELD)\UNINST.EXE
    COPY $(ISHIELD)\UNINST.EXE $@

## compile our rul file
$(NAME).001\SETUP.INS : SETUP.RUL
    $(ISHIELD)\COMPILE.EXE /D_W$(PRFX)_=1 SETUP.RUL
    COPY SETUP.INS $@

$(NAME).001\README.1ST : README.1ST
    COPY README.1ST $@

## compile our packing list file
$(NAME).001\SETUP.PKG : MAKEFILE $(NAME).001\$(NAME).Z
    ECHO 1;         >$(NAME).LST
    ECHO $(NAME).Z >>$(NAME).LST
    $(ISHIELD)\PACKLIST.EXE $(NAME).LST
    COPY SETUP.PKG $@

## split the file if overlarge
##   The -d flag is used to make sure that disk one will have
##   enough space for the installation script, setup.exe and other
##   required files
## $(ISHIELD)\SPLIT.EXE -f1370 -d1@700 $(NAME).Z
## COPY SPWIN.1 $(NAME).001
## COPY disk2.id disk2
## COPY SPWIN.2 disk2

$(NAME).001\$(NAME).Z : $(NAME).EXE $(NAME).INI REMOTE.EXE SPWCC.EXE \
    SPCC.EXE README.TXT
    COPY $(NAME).EXE $(NAME).R
    COPY $(NAME).INI $(NAME).R
    COPY REMOTE.EXE $(NAME).R
    COPY SPWCC.EXE $(NAME).R
    COPY SPCC.EXE $(NAME).R
    COPY README.TXT $(NAME).R
    DEL $(NAME).Z >NUL
    $(ISHIELD)\ICOMP.EXE $(NAME).R\*.* $(NAME).Z
    COPY $(NAME).Z $@

ISX : $(NAME)\144MB\DISK1\_SETUP.1

$(NAME)\144MB\DISK1\_SETUP.1 : $(NAME).EXE $(NAME).INI REMOTE.EXE SPWCC.EXE \
    SPCC.EXE README.TXT
    COPY $(NAME).EXE $(NAME).R
    COPY $(NAME).INI $(NAME).R
    COPY REMOTE.EXE $(NAME).R
    COPY SPWCC.EXE $(NAME).R
    COPY SPCC.EXE $(NAME).R
    COPY README.TXT $(NAME).R
    C:\PROGRA~1\INSTAL~1\ISEXPR~2\ISX.EXE D:\MAKE\SPW\$(NAME).IWZ
